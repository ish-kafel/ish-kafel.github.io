<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes">
  <title>Nonogram Solver</title>
  <style>
    body {
      /*width: 500px;*/
      /*line-height: 9.1px;*/
    }

    div#ta {
      display: flex;
      align-items: flex-start;
    }

    div#solution {
      font-family: Consolas, monospace;
      height: 260px;
      font-size: 12px;
      white-space: pre;
      /*overflow: scroll;*/
    }

    span.block {
      letter-spacing: -0.53px;
    }

    textarea {
      width: 100px;
    }

    #cc {
      -moz-writing-mode: vertical-lr;
      -webkit-writing-mode: vertical-lr;
      writing-mode: vertical-lr;
    }
  </style>
</head>

<body>
  <div id="ta">
    <textarea id="rr" cols="40" placeholder="行数组" rows="1"></textarea><textarea id="cc" cols="40" placeholder="列数组" rows="1"></textarea>
  </div><br>
  <button id="btn">求解</button> <button id="last">上一步</button> <button id="next">下一步</button><br><br><button id="show">展示全部</button> <button id="share">分享题目</button><br>
  <div id="solution"></div>
  <script>
    const log = console.log.bind(console)
    const $ = s => {
      let n = document.querySelectorAll(s)
      if (n.length === 1) return n[0]
      return n
    }
    if (!Array.prototype.toSpliced) {
      Array.prototype.toSpliced = function(...args) {
        return Array.from(this).splice(...args);
      };
    }
    const write = function(msg) {
      //document.write
      progstr += msg + '<br><br>'
    }
    const spreg = /(?<=\d)(?=\d)/
    let correct, cross, unsettled, updatecorrect, updatecross, progstr, sr, sc, rows, cols, rowsset, colsset, solverow, solvecol, solve, update, n, save, mapp, maxcoll, maxrowl, solutionarr, solutioni, solutionl
    //window.addEventListener('DOMContentLoaded', function() {
    const params = new URL(document.location).searchParams
    let rr = $('#rr')
    let pr = (params.get('r') ?? '232,221,251,522,225,52,222,232,222,25,522,225,152,122,232').split(',')
    rr.value = pr.join('\n')
    rr.setAttribute('rows', pr.length)
    let cc = $('#cc')
    let pc = (params.get('c') ?? '212,1212,1132,3313,3133,1231,1212,12121,2121,1321,3313,3133,2311,2121,212').split(',')
    cc.value = pc.join('\n')
    cc.setAttribute('rows', pc.length)
    //})

    function check() {
      //if (rows.length !== cols.length) return '行列数不一致'
      //if (rows.length !== sc) return '行数不为' + sc
      //if (cols.length !== sr) return '列数不为' + sr
      for (let i = 0; i < rows.length; i++) {
        if (rows[i].reduce((p, c) => p + c) + rows[i].length - 1 > sc) return '第' + (i + 1) + '行结果超过' + sc
      }
      for (let i = 0; i < cols.length; i++) {
        if (cols[i].reduce((p, c) => p + c) + cols[i].length - 1 > sr) return '第' + (i + 1) + '列结果超过' + sr
      }
      if (rows.flat().reduce((p, c) => p + c) !== cols.flat().reduce((p, c) => p + c)) {
        return '行列求和不一致'
      }
      return false
    }

    function gen(arr, t) {
      arr = arr.slice()
      let res = [new Array(t).fill(2)]
      let tmp = []
      let len = arr.length
      while (arr[0]) {
        while (res[0]) {
          let start = res[0].lastIndexOf(1) + 1 + (arr.length !== len)
          for (let i = start; i <= t - arr[0]; i++) {
            tmp.push(res[0].toSpliced(i, arr[0], ...new Array(arr[0]).fill(1)))
          }
          res.shift()
        }
        arr.shift()
        res.push(...tmp)
        tmp = []
      }
      return res
    }

    function merge(arr) {
      if (arr.length === 1) return arr[0].slice()
      let base = arr[0].slice()
      for (let i = 1; i < arr.length; i++) {
        for (let j = 0; j < arr[i].length; j++) {
          if (base[j] !== arr[i][j]) {
            base[j] = 0
          }
        }
      }
      return base
    }

    function writesolve() {
      let arr = solve.map(e => e.slice())
      for (let u of update) {
        arr[u[0]][u[1]] = solve[u[0]][u[1]] + 2
      }
      arr = arr.map(e => e.map(e => mapp[e]))
      let strarr = new Array(maxcoll).fill(' '.repeat(maxrowl * 2))
      for (let col of cols) {
        col = col.slice().reverse()
        for (let i = 0; i < maxcoll; i++) {
          strarr[maxcoll - 1 - i] += col[i] ? (col[i] + '').padStart(2, ' ') : ' '.repeat(2)
        }
      }
      write(strarr.join('<br>') + '<br>' + arr.map((e, i) => rows[i].map(e => (e + '').padStart(2, ' ')).join('').padStart(maxrowl * 2, ' ') + '<span class="block">' + e.join('') + '</span>').join('<br>'))
    }

    function clone() {
      save = {
        solverow: solverow.map(e => e.slice()),
        solvecol: solvecol.map(e => e.slice()),
        rowsset: rowsset.map(e => e.map(e1 => e1.slice())),
        colsset: colsset.map(e => e.map(e1 => e1.slice())),
        n,
        solve: solve.map(e => e.slice())
      }
    }

    function load() {
      solverow = save.solverow.map(e => e.slice())
      solvecol = save.solvecol.map(e => e.slice())
      rowsset = save.rowsset.map(e => e.map(e1 => e1.slice()))
      colsset = save.colsset.map(e => e.map(e1 => e1.slice()))
      n = save.n
      solve = save.solve.map(e => e.slice())
    }

    function ans() {
      while (update.length) {
        for (let u of update) {
          if (u[2] === 0) {
            solverow[u[0]] = merge(rowsset[u[0]])
          } else if (u[2] === 1) {
            solvecol[u[1]] = merge(colsset[u[1]])
          }
        }
        update = []
        for (let i = 0; i < sr; i++) {
          for (let j = 0; j < sc; j++) {
            let r = solverow[i][j]
            let c = solvecol[j][i]
            if (r && c) {
              if (r !== c) {
                solve[i][j] = 5
                write('n=' + n + '\u3000')
                writesolve()
                return [i, j]
              } //Error
              if (solve[i][j] != r) {
                update.push([i, j, ])
                solve[i][j] = r
              }
            } else if (r || c) {
              if (solve[i][j] != Math.max(r, c)) {
                update.push([i, j, +(Math.max(r, c) === r)])
                solve[i][j] = Math.max(r, c)
              }
            }
          }
        }
        for (let u of update) {
          if (u[2] === 0) {
            rowsset[u[0]] = rowsset[u[0]].filter(e => e[u[1]] === solve[u[0]][u[1]])
            if (rowsset[u[0]].length === 0) {
              for (let j = 0; j < sc; j++) {
                if (!solve[u[0]][j])
                  solve[u[0]][j] = 5
              }
              write('n=' + n + '\u3000')
              writesolve()
              return [u[0], -1] //Error
            }
          } else if (u[2] === 1) {
            colsset[u[1]] = colsset[u[1]].filter(e => e[u[0]] === solve[u[0]][u[1]])
            if (colsset[u[1]].length === 0) {
              for (let i = 0; i < sr; i++) {
                if (!solve[i][u[1]])
                  solve[i][u[1]] = 5
              }
              write('n=' + n + '\u3000')
              writesolve()
              return [-1, u[1]] //Error
            }
          }
        }
        write('n=' + n + '\u3000')
        writesolve()
        n++
      }
      return collect()
    }

    function collect() {
      let res = []
      for (let i = 0; i < sr; i++) {
        for (let j = 0; j < sc; j++) {
          if (!solve[i][j]) res.push([i, j])
        }
      }
      return res
    }

    function assume(x, y) {
      write('n=' + n + '，假设' + (x + 1) + '行' + (y + 1) + '列')
      solve[x][y] = 1
      update.push([x, y, 0, 1])
      update.push([x, y, 1, 1])
      rowsset[x] = rowsset[x].filter(e => e[y] === 1)
      colsset[y] = colsset[y].filter(e => e[x] === 1)
      writesolve()
      n++
    }

    function reject(x, y) {
      write('n=' + n + '，拒绝假设' + (x + 1) + '行' + (y + 1) + '列')
      solve[x][y] = 2
      update = [[x, y, 0, 2], [x, y, 1, 2]]
      rowsset[x] = rowsset[x].filter(e => e[y] === 2)
      colsset[y] = colsset[y].filter(e => e[x] === 2)
      writesolve()
    }

    function queue() {
      let rej = 0
      let nexttry = 0
      let collectij = [0]
      let i = -1
      while (collectij.length) {
        if (rej) {
          load()
          reject(...rej)
          rej = 0
        }
        collectij = ans()
        if (collectij.length === 0) {
          write('已解决')
          return
        }
        if (!Array.isArray(collectij[0])) {
          progstr = '<br>题目出错，否则无解'
          return
        }
        if (nexttry) {
          i = collectij.findIndex(e => e[0] == nexttry[0] && e[1] == nexttry[1])
          nexttry = 0
        }
        if (i == -1) i = Math.floor(Math.random() * collectij.length)
        let x, y, re
        clone();
        while (collectij.length) {
          ;
        [x, y] = collectij.splice(i, 1)[0]
          assume(x, y)
          re = ans()
          if (re.length == 0) {
            write('已解决')
            return
          }
          if (Array.isArray(re[0])) {
            i = Math.floor(Math.random() * collectij.length)
            write('无法确定，更换下一个')
          } else {
            rej = [x, y]
            nexttry = [re[0] + 1 ? re[0] : x, re[1] + 1 ? re[1] : y]
            write('无解，在' + (re[0] + 1 ? re[0] + 1 + '行' : '') + (re[1] + 1 ? re[1] + 1 + '列' : ''))
            break
          }
          load()
        }
      }
      write('本题无解或无唯一解')
      return
    }

    function init() {
      unsettled = '⬛'
      correct = '🟩'
      cross = '❌'
      updatecorrect = '✅'
      updatecross = '❎'
      error = '❓'
      mapp = [unsettled, correct, cross, updatecorrect, updatecross, error]
      progstr = '<br>'
      rows = rr.value.replace(/[^0-9\n ]/g, ' ').split('\n').map(e => e.trim().split(spreg).map(e1 => +e1.replace(' ', '')))
      cols = cc.value.replace(/[^0-9\n ]/g, ' ').split('\n').map(e => e.trim().split(spreg).map(e1 => +e1.replace(' ', '')))
    }
    $('#btn').addEventListener('click', function() {
      init()
      let prep = check()
      if (prep) {
        write(prep + ',请检查')
      } else {
        maxcoll = Math.max(...cols.map(e => e.length))
        maxrowl = Math.max(...rows.map(e => e.length))
        sr = rows.length
        sc = cols.length
        rowsset = rows.map(e => gen(e, sc))
        colsset = cols.map(e => gen(e, sr))
        solverow = []
        solvecol = []
        solve = new Array(sr).fill(0).map(e => new Array(sc).fill(0))
        update = new Array(sc).fill(0).map((_, i) => [0, i, 1]).concat(new Array(sr).fill(0).map((_, i) => [i, 0, 0]))
        n = 1
        save = {}
        solverow = []
        solvecol = []
        queue()
      }
      solutionarr = progstr.split(/(?=<br>n=)/g).map(e => e + '<br><br>\u3000')
      solutioni = 0
      solutionl = solutionarr.length
      solution.innerHTML = solutionarr[solutioni]
    })
    $('#last').addEventListener('click', function() {
      if (solutionl) solution.innerHTML = solutionarr[solutioni = Math.max(0, solutioni - 1)]
    })
    $('#next').addEventListener('click', function() {
      if (solutionl) solution.innerHTML = solutionarr[solutioni = Math.min(solutionl - 1, solutioni + 1)]
    })
    $('#show').addEventListener('click', function() {
      if (solutionl) solution.innerHTML = solutionarr.join('')
    })
    $('#share').addEventListener('click', function() {
      init()
      let chk = check()
      if (chk) {
        alert(chk + '，请修改后再分享')
        return
      }
      let loc = document.location
      let path = loc.origin + loc.pathname + '?' + new URLSearchParams({ r: rr.value.split('\n').join(','), c: cc.value.split('\n').join(',') }).toString().replaceAll('%2C', ',')
      if (navigator.clipboard && navigator.permissions) {
        navigator.permissions.query({ name: "clipboard-write" }).then(result => navigator.clipboard.writeText(path).then(
          _ => alert('已复制到剪贴板'),
          _ => alert('未复制到剪贴板')))
      } else {
        const textArea = document.createElement('textArea')
        textArea.value = path
        textArea.style.width = 0
        textArea.style.position = 'fixed'
        textArea.style.left = '-999px'
        textArea.style.top = '10px'
        textArea.setAttribute('readonly', 'readonly')
        document.body.appendChild(textArea)
        textArea.select()
        let res = document.execCommand('copy')
        document.body.removeChild(textArea)
        alert(res ? '已复制到剪贴板' : '未复制到剪贴板')
      }
    })
    $('#ta').addEventListener('input', function(e) {
      if (e.target.tagName == 'TEXTAREA') e.target.setAttribute('rows', e.target.value.split('\n').length)
    })

    window.addEventListener('error', e => alert(e.message))
  </script>
</body>

</html>
